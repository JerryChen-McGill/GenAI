<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What you want to learn?</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Firebase SDK for Authentication -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        // ç¡®ä¿ marked å¯ç”¨
        if (typeof marked === 'undefined') {
            console.error('Marked library failed to load');
        }
    </script>
</head>
<body>
    <!-- èœå•æŒ‰é’® -->
    <button class="menu-toggle-btn" id="menuToggleBtn" aria-label="Toggle menu">
        â˜°
    </button>
    
    <!-- ä¾§è¾¹æ é®ç½©å±‚ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <!-- ä¾§è¾¹æ å¤´éƒ¨ -->
        <div class="sidebar-header">
            <button class="sidebar-close-btn" id="sidebarCloseBtn" aria-label="Close menu">
                âœ•
            </button>
        </div>
        
        <!-- ä¾§è¾¹æ èœå• -->
        <nav class="sidebar-menu">
            <div class="sidebar-menu-item" id="menuItemAccount">
                <div class="sidebar-menu-item-icon">ğŸ‘¤</div>
                <div class="sidebar-menu-item-text">My Account</div>
            </div>
            <div class="sidebar-menu-item" id="menuItemInterest">
                <div class="sidebar-menu-item-icon">â¤ï¸</div>
                <div class="sidebar-menu-item-text">My Interest</div>
            </div>
            
            <!-- My Prompts å¯å±•å¼€èœå•é¡¹ -->
            <div class="sidebar-menu-item expandable-menu-item" id="menuItemPrompts">
                <div class="sidebar-menu-item-icon">ğŸ“</div>
                <div class="sidebar-menu-item-text">My Prompts</div>
                <div class="sidebar-menu-item-arrow">â–¶</div>
            </div>
            <div class="expandable-menu-content" id="promptsListContent">
                <div class="favorites-list" id="promptsList">
                    <!-- Prompt åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            
            <!-- My Questions å¯å±•å¼€èœå•é¡¹ -->
            <div class="sidebar-menu-item expandable-menu-item" id="menuItemQuestions">
                <div class="sidebar-menu-item-icon">ğŸ“š</div>
                <div class="sidebar-menu-item-text">My Questions</div>
                <div class="sidebar-menu-item-arrow">â–¶</div>
            </div>
            <div class="expandable-menu-content" id="questionsListContent">
                <div class="favorites-list" id="favoritesList">
                    <!-- æ”¶è—åˆ—è¡¨å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </nav>
    </div>
    
    <!-- è´¦æˆ·ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="accountModalOverlay">
        <div class="modal" id="accountModal">
            <div class="modal-header">
                <h2>My Account</h2>
                <button class="modal-close-btn" id="accountModalClose">âœ•</button>
            </div>
            <div class="modal-content">
                <div class="modal-avatar-section">
                    <div class="modal-avatar" id="accountAvatar">
                        <!-- å¤´åƒåˆå§‹å­—æ¯å°†é€šè¿‡ JavaScript åŠ¨æ€è®¾ç½® -->
                    </div>
                    <div class="modal-avatar-camera" title="Change profile picture">ğŸ“·</div>
                </div>
                <div class="modal-field">
                    <label for="accountEmail">Email (è´¦å·)</label>
                    <input type="email" id="accountEmail" readonly>
                </div>
                <div class="modal-field">
                    <label for="accountDisplayName">Display Name (æ˜¾ç¤ºåç§°)</label>
                    <input type="text" id="accountDisplayName" placeholder="Enter your display name">
                </div>
                <div class="modal-field">
                    <label for="accountUsername">Username (ç”¨æˆ·å)</label>
                    <input type="text" id="accountUsername" placeholder="Enter your username">
                </div>
                <div class="modal-field-info">
                    ä¸ªäººèµ„æ–™æœ‰åŠ©äºä»–äººè¯†åˆ«ä½ çš„èº«ä»½ã€‚ä½ çš„å§“åå’Œç”¨æˆ·åä¹Ÿå°†ç”¨äºåº”ç”¨ã€‚
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" id="accountModalLogout">Log out</button>
                <button class="modal-btn modal-btn-save" id="accountModalSave">Save</button>
            </div>
        </div>
    </div>
    
    <!-- å…´è¶£åå¥½æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="interestModalOverlay">
        <div class="modal" id="interestModal">
            <div class="modal-header">
                <h2>My Interest</h2>
                <button class="modal-close-btn" id="interestModalClose">âœ•</button>
            </div>
            <div class="modal-content">
                <div id="interestContent">
                    <!-- å…´è¶£åå¥½å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" id="interestModalCancel">å…³é—­</button>
                <button class="modal-btn modal-btn-save" id="interestModalGoToSettings">Go to Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Prompt è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="promptDetailModalOverlay">
        <div class="modal" id="promptDetailModal">
            <div class="modal-header">
                <h2>Prompt Details</h2>
                <button class="modal-close-btn" id="promptDetailModalClose">âœ•</button>
            </div>
            <div class="modal-content">
                <div id="promptDetailContent">
                    <!-- Prompt è¯¦æƒ…å†…å®¹å°†é€šè¿‡ JavaScript åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-cancel" id="promptDetailModalCancel">å…³é—­</button>
                <button class="modal-btn modal-btn-save" id="promptDetailModalImport">Import</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="panel left-panel">
            <h1>What you want to learn?</h1>
            
            <h3 for="topic">The topic I want to learn:</h3>
            <input type="text" id="topic" placeholder="e.g., addition, subtraction, multiplication">

            <div class="more-options-link" id="moreBtn">More Options</div>
            
            <div class="more-options" id="moreOptions">
                <label for="grade">Grade:</label>
                <select id="grade">
                    <option value="">Select Grade</option>
                    <option value="6">6th Grade</option>
                    <option value="7">7th Grade</option>
                    <option value="8">8th Grade</option>
                    <option value="9">9th Grade</option>
                    <option value="10">10th Grade</option>
                    <option value="11">11th Grade</option>
                    <option value="12">12th Grade</option>
                </select>

                <label for="difficulty">Difficulty:</label>
                <select id="difficulty">
                    <option value="">Select Difficulty</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                    <option value="challenging">Challenging</option>
                </select>

                <label for="number">Number of Problems:</label>
                <input type="number" id="number" min="1" max="10" value="1">

                <label for="requirements">Additional Requirements:</label>
                <input type="text" id="requirements" placeholder="e.g., word problems, step-by-step solutions">
            </div>
            
            <h3>The topics I want to include in the question:</h3>
            <div class="tag-container" id="tagContainer">
                <!-- æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </div>
            <div class="tag-input-container" id="tagInputContainer">
                <input type="text" id="tagInput" placeholder="Type and press Enter to add a tag">
                <button id="addTagBtn">Add</button>
            </div>
            <button id="showTagInputBtn" class="add-tag-btn">+</button>

            <div class="more-options-link" id="savePromptBtn" style="margin-top: var(--spacing-lg);">Save Prompt</div>

            <button id="generateBtn"><span>Generate</span></button>
        </div>
        <div class="panel right-panel">
            <h1>Math Question</h1>
            <div id="result"></div>
            
            <!-- Hints æ ‡é¢˜å’Œå†…å®¹ -->
            <div class="expandable-section" id="hintExpandableSection">
                <button class="section-title-btn" id="hintBtn">
                    <span class="section-title-arrow">â–¶</span>
                    <span class="section-title-text">Show Hints</span>
                </button>
                <div id="hintSection" class="section-content"></div>
            </div>
            
            <!-- Solution æ ‡é¢˜å’Œå†…å®¹ -->
            <div class="expandable-section" id="solutionExpandableSection">
                <button class="section-title-btn" id="solutionBtn">
                    <span class="section-title-arrow">â–¶</span>
                    <span class="section-title-text">Show Solution</span>
                </button>
                <div id="solutionSection" class="section-content"></div>
            </div>
            
            <!-- æ”¶è—æŒ‰é’®å®¹å™¨ -->
            <div id="favoriteBtnContainer" style="margin-top: var(--spacing-lg); text-align: center;"></div>
        </div>
    </div>

    <script>
        // é…ç½®APIåŸºç¡€URL
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5000'  // æœ¬åœ°å¼€å‘ç¯å¢ƒ
            : '';  // ç”Ÿäº§ç¯å¢ƒï¼ˆRenderï¼‰ä½¿ç”¨ç›¸å¯¹è·¯å¾„

        // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·åå¥½æ•°æ®
        function checkUserPreferences() {
            const preferences = localStorage.getItem('userPreferences');
            console.log('Checking user preferences:', preferences);
            if (!preferences) {
                console.log('No preferences found, redirecting to personalization');
                window.location.href = '/';
                return;
            }
            
            try {
                const parsedPreferences = JSON.parse(preferences);
                console.log('Parsed preferences:', parsedPreferences);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘ä¸€ä¸ªé—®é¢˜çš„ç­”æ¡ˆ
                const hasAnswers = parsedPreferences.question1 || parsedPreferences.question2 || parsedPreferences.question3;
                if (!hasAnswers) {
                    console.log('No answers found in preferences, redirecting to personalization');
                    window.location.href = '/';
                    return;
                }
                
                console.log('User preferences validated successfully');
            } catch (error) {
                console.error('Error parsing preferences:', error);
                console.log('Redirecting to personalization due to parsing error');
                window.location.href = '/';
                return;
            }
        }

        // ä»localStorageåŠ è½½ç”¨æˆ·åå¥½
        function loadUserPreferences() {
            const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            const tagContainer = document.getElementById('tagContainer');
            tagContainer.innerHTML = '';
            
            // ä»æ‰€æœ‰é—®é¢˜åŠ è½½æ ‡ç­¾
            const allTags = new Set(); // ä½¿ç”¨Setæ¥å»é‡
            
            // ä»question1åŠ è½½æ ‡ç­¾ï¼ˆå…´è¶£çˆ±å¥½ï¼‰
            if (preferences.question1) {
                preferences.question1.split(',').forEach(tag => {
                    const trimmedTag = tag.trim();
                    if (trimmedTag) allTags.add(trimmedTag);
                });
            }
            
            // ä»question2åŠ è½½æ ‡ç­¾ï¼ˆæ„Ÿå…´è¶£çš„è¯é¢˜ï¼‰
            if (preferences.question2) {
                preferences.question2.split(',').forEach(tag => {
                    const trimmedTag = tag.trim();
                    if (trimmedTag) allTags.add(trimmedTag);
                });
            }
            
            // ä»question3åŠ è½½æ ‡ç­¾ï¼ˆå–œæ¬¢çš„å†…å®¹ç±»å‹ï¼‰
            if (preferences.question3) {
                preferences.question3.split(',').forEach(tag => {
                    const trimmedTag = tag.trim();
                    if (trimmedTag) allTags.add(trimmedTag);
                });
            }

            // åˆ›å»ºæ‰€æœ‰æ ‡ç­¾
            allTags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag';
                tagElement.textContent = tag;
                tagElement.onclick = () => {
                    tagElement.classList.toggle('selected');
                    saveTagsToLocalStorage();
                };
                tagContainer.appendChild(tagElement);
            });
        }

        // è·å–é€‰ä¸­çš„æ ‡ç­¾
        function getSelectedTags() {
            const selectedTags = Array.from(document.querySelectorAll('.tag.selected'))
                .map(tag => tag.textContent);
            return selectedTags;
        }

        async function generateProblems() {
            const generateBtn = document.getElementById('generateBtn');
            const generateBtnText = generateBtn.querySelector('span');
            const result = document.getElementById('result');
            const grade = document.getElementById('grade').value;
            const difficulty = document.getElementById('difficulty').value;
            const number = parseInt(document.getElementById('number').value);
            const topic = document.getElementById('topic').value;
            const requirements = document.getElementById('requirements').value;
            const selectedTags = getSelectedTags();

            if (!topic) {
                result.className = '';
                result.textContent = 'Please enter what you want to learn.';
                // éšè— Hints å’Œ Solution åŒºåŸŸ
                document.getElementById('hintExpandableSection').classList.remove('has-content');
                document.getElementById('solutionExpandableSection').classList.remove('has-content');
                return;
            }

            // æ·»åŠ è°ƒè¯•æ—¥å¿—
            console.log('Sending data:', {
                grade,
                difficulty,
                number,
                topic,
                requirements,
                selectedTags
            });

            generateBtn.classList.add('generating');
            generateBtnText.textContent = 'Generating';
            generateBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        grade, 
                        difficulty, 
                        number, 
                        topic, 
                        requirements,
                        selectedTags 
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error || 'Unknown error'}`);
                }

                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }

                // ä¿®æ”¹ Markdown æ¸²æŸ“éƒ¨åˆ†
                try {
                    if (typeof marked === 'undefined') {
                        throw new Error('Marked library is not loaded');
                    }
                    
                    // æ˜¾ç¤ºé—®é¢˜éƒ¨åˆ† - ç›´æ¥ä½¿ç”¨ resultï¼Œåº”ç”¨ section-content æ ·å¼
                    result.className = 'section-content show'; // ç›´æ¥ç»™ result åº”ç”¨æ ·å¼
                    result.innerHTML = marked.parse(data.problem);
                    
                    // æ·»åŠ æ”¶è—æŒ‰é’®åˆ°å®¹å™¨ä¸­
                    const favoriteBtnContainer = document.getElementById('favoriteBtnContainer');
                    favoriteBtnContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
                    
                    const favoriteBtn = document.createElement('button');
                    favoriteBtn.className = 'favorite-btn';
                    favoriteBtn.id = 'favoriteBtn';
                    favoriteBtn.innerHTML = '<span class="favorite-btn-icon">â™¡</span> <span>Add to Favorites</span>';
                    
                    // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—ï¼ˆé€šè¿‡é—®é¢˜æ–‡æœ¬çš„å‰200ä¸ªå­—ç¬¦åŒ¹é…ï¼‰
                    const favorites = JSON.parse(localStorage.getItem('favoriteQuestions') || '[]');
                    const currentProblemHash = data.problem.substring(0, 200).trim();
                    const isFavorited = favorites.some(fav => {
                        const favProblemHash = fav.problem.substring(0, 200).trim();
                        return favProblemHash === currentProblemHash;
                    });
                    
                    if (isFavorited) {
                        favoriteBtn.classList.add('favorited');
                        favoriteBtn.innerHTML = '<span class="favorite-btn-icon">â™¥</span> <span>Favorited</span>';
                    }
                    
                    // æ”¶è—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    favoriteBtn.addEventListener('click', function() {
                        const wasFavorited = this.classList.contains('favorited');
                        saveToFavorites(data, wasFavorited);
                        this.classList.toggle('favorited');
                        if (this.classList.contains('favorited')) {
                            this.innerHTML = '<span class="favorite-btn-icon">â™¥</span> <span>Favorited</span>';
                        } else {
                            this.innerHTML = '<span class="favorite-btn-icon">â™¡</span> <span>Add to Favorites</span>';
                        }
                        // æ›´æ–°æ”¶è—åˆ—è¡¨
                        loadFavoritesList();
                    });
                    
                    favoriteBtnContainer.appendChild(favoriteBtn);

                    // è®¾ç½®æç¤ºéƒ¨åˆ†
                    const hintSection = document.getElementById('hintSection');
                    const hintExpandableSection = document.getElementById('hintExpandableSection');
                    if (data.hints) {
                        hintSection.innerHTML = marked.parse(data.hints);
                        hintExpandableSection.classList.add('has-content'); // æ˜¾ç¤º Hints åŒºåŸŸ
                    } else {
                        hintExpandableSection.classList.remove('has-content'); // éšè— Hints åŒºåŸŸ
                    }

                    // è®¾ç½®è§£ç­”éƒ¨åˆ†ï¼ˆåŒ…å«æ­¥éª¤å’Œç­”æ¡ˆï¼‰
                    const solutionSection = document.getElementById('solutionSection');
                    const solutionExpandableSection = document.getElementById('solutionExpandableSection');
                    if (data.solution || data.answer) {
                        let solutionContent = '';
                        if (data.solution) {
                            solutionContent += '### Step-by-Step Solution\n' + data.solution;
                        }
                        if (data.answer) {
                            solutionContent += '\n\n### Final Answer\n' + data.answer;
                        }
                        solutionSection.innerHTML = marked.parse(solutionContent);
                        solutionExpandableSection.classList.add('has-content'); // æ˜¾ç¤º Solution åŒºåŸŸ
                    } else {
                        solutionExpandableSection.classList.remove('has-content'); // éšè— Solution åŒºåŸŸ
                    }

                    // è®¾ç½®æŒ‰é’®äº‹ä»¶
                    const hintBtn = document.getElementById('hintBtn');
                    const solutionBtn = document.getElementById('solutionBtn');
                    const hintTitleText = hintBtn.querySelector('.section-title-text');
                    const solutionTitleText = solutionBtn.querySelector('.section-title-text');

                    hintBtn.onclick = function() {
                        hintSection.classList.toggle('show');
                        this.classList.toggle('active');
                        hintTitleText.textContent = hintSection.classList.contains('show') ? 'Hide Hints' : 'Show Hints';
                    };

                    solutionBtn.onclick = function() {
                        solutionSection.classList.toggle('show');
                        this.classList.toggle('active');
                        solutionTitleText.textContent = solutionSection.classList.contains('show') ? 'Hide Solution' : 'Show Solution';
                    };

                } catch (markdownError) {
                    console.error('Markdown parsing error:', markdownError);
                    result.textContent = data.problems; // é™çº§ä¸ºçº¯æ–‡æœ¬æ˜¾ç¤º
                }
            } catch (error) {
                console.error('Error:', error);
                result.textContent = `Error: ${error.message}. Please make sure the server is running and try again.`;
            } finally {
                generateBtn.classList.remove('generating');
                generateBtnText.textContent = 'Generate';
                generateBtn.disabled = false;
            }
        }

        // æ›´å¤šé€‰é¡¹é“¾æ¥ç‚¹å‡»äº‹ä»¶
        document.getElementById('moreBtn').addEventListener('click', function() {
            const moreOptions = document.getElementById('moreOptions');
            const isExpanded = moreOptions.classList.contains('show');
            
            if (isExpanded) {
                moreOptions.classList.remove('show');
                this.textContent = 'More Options';
            } else {
                moreOptions.classList.add('show');
                this.textContent = 'Less Options';
            }
        });

        // ä¿®æ”¹æ ‡ç­¾è¾“å…¥ç›¸å…³å‡½æ•°
        function addTag(tagText) {
            if (!tagText.trim()) return;
            
            const tagContainer = document.getElementById('tagContainer');
            const tagElement = document.createElement('div');
            tagElement.className = 'tag';
            tagElement.textContent = tagText.trim();
            tagElement.onclick = () => {
                tagElement.classList.toggle('selected');
                saveTagsToLocalStorage();
            };
            tagContainer.appendChild(tagElement);
            
            // ä¿å­˜åˆ°localStorage
            saveTagsToLocalStorage();
            
            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶éšè—
            const tagInput = document.getElementById('tagInput');
            tagInput.value = '';
            document.getElementById('tagInputContainer').style.display = 'none';
            document.getElementById('showTagInputBtn').style.display = 'block';
        }

        function saveTagsToLocalStorage() {
            const tags = Array.from(document.querySelectorAll('.tag'))
                .map(tag => tag.textContent);
            
            // è·å–ç°æœ‰çš„ç”¨æˆ·åå¥½
            const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            
            // æ›´æ–°æ‰€æœ‰é—®é¢˜çš„æ ‡ç­¾
            preferences.question1 = tags.join(', ');
            preferences.question2 = tags.join(', ');
            preferences.question3 = tags.join(', ');
            
            // ä¿å­˜å›localStorage
            localStorage.setItem('userPreferences', JSON.stringify(preferences));
        }

        // åˆå§‹åŒ–æ ‡ç­¾è¾“å…¥åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const tagInput = document.getElementById('tagInput');
            const addTagBtn = document.getElementById('addTagBtn');
            const showTagInputBtn = document.getElementById('showTagInputBtn');
            const tagInputContainer = document.getElementById('tagInputContainer');

            // æ˜¾ç¤ºæ ‡ç­¾è¾“å…¥æ¡†
            showTagInputBtn.addEventListener('click', () => {
                tagInputContainer.style.display = 'block';
                showTagInputBtn.style.display = 'none';
                tagInput.focus();
            });

            // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            addTagBtn.addEventListener('click', () => {
                addTag(tagInput.value);
            });

            // å›è½¦é”®æ·»åŠ æ ‡ç­¾
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    addTag(tagInput.value);
                }
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—è¾“å…¥æ¡†
            document.addEventListener('click', (e) => {
                if (!tagInputContainer.contains(e.target) && e.target !== showTagInputBtn) {
                    if (tagInput.value.trim()) {
                        addTag(tagInput.value);
                    } else {
                        tagInputContainer.style.display = 'none';
                        showTagInputBtn.style.display = 'block';
                    }
                }
            });
        });

        // ä¿®æ”¹å…¨å±€å›è½¦äº‹ä»¶å¤„ç†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !document.getElementById('tagInputContainer').contains(event.target)) {
                document.getElementById('generateBtn').click();
            }
        });

        // å°† onclick äº‹ä»¶ç›‘å¬å™¨æ·»åŠ åˆ°æŒ‰é’®
        document.getElementById('generateBtn').addEventListener('click', generateProblems);
        
        // ============================================
        // Save Prompt åŠŸèƒ½
        // ============================================
        
        /**
         * ä¿å­˜å½“å‰ Prompt è®¾ç½®
         */
        function savePromptSettings() {
            const topic = document.getElementById('topic').value;
            const grade = document.getElementById('grade').value;
            const difficulty = document.getElementById('difficulty').value;
            const number = document.getElementById('number').value;
            const requirements = document.getElementById('requirements').value;
            const selectedTags = getSelectedTags();
            
            // å¦‚æœæ²¡æœ‰ä¸»é¢˜ï¼Œæç¤ºç”¨æˆ·
            if (!topic.trim()) {
                alert('Please enter a topic before saving.');
                return;
            }
            
            // åˆ›å»º Prompt è®¾ç½®å¯¹è±¡
            const promptSettings = {
                id: Date.now().toString(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
                topic: topic,
                grade: grade || '',
                difficulty: difficulty || '',
                number: number || '1',
                requirements: requirements || '',
                selectedTags: selectedTags,
                title: getPromptTitle(topic, grade, difficulty), // ç”Ÿæˆæ ‡é¢˜
                createdAt: new Date().toISOString()
            };
            
            // ä» localStorage è¯»å–å·²ä¿å­˜çš„ Prompts
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '[]');
            
            // æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
            savedPrompts.unshift(promptSettings);
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('savedPrompts', JSON.stringify(savedPrompts));
            
            console.log('Prompt è®¾ç½®å·²ä¿å­˜:', promptSettings);
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            const saveBtn = document.getElementById('savePromptBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saved!';
            saveBtn.style.color = 'var(--success-green)';
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.color = '';
            }, 2000);
            
            // æ›´æ–° Prompt åˆ—è¡¨
            loadPromptsList();
        }
        
        /**
         * ç”Ÿæˆ Prompt æ ‡é¢˜
         */
        function getPromptTitle(topic, grade, difficulty) {
            let title = topic;
            if (grade) {
                title += ` (Grade ${grade})`;
            }
            if (difficulty) {
                title += ` - ${difficulty}`;
            }
            return title.length > 40 ? title.substring(0, 40) + '...' : title;
        }
        
        /**
         * åŠ è½½ Prompt åˆ—è¡¨
         */
        function loadPromptsList() {
            const promptsList = document.getElementById('promptsList');
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '[]');
            
            // æ¸…ç©ºåˆ—è¡¨
            promptsList.innerHTML = '';
            
            if (savedPrompts.length === 0) {
                promptsList.innerHTML = '<div class="favorites-empty">No saved prompts</div>';
                return;
            }
            
            // æ˜¾ç¤º Prompt åˆ—è¡¨
            savedPrompts.forEach(prompt => {
                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.dataset.promptId = prompt.id;
                
                const date = new Date(prompt.createdAt);
                const dateStr = date.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                item.innerHTML = `
                    <div class="favorite-item-content">
                        <div class="favorite-item-title">${prompt.title}</div>
                        <div class="favorite-item-date">${dateStr}</div>
                    </div>
                    <button class="favorite-item-delete" data-prompt-id="${prompt.id}" title="åˆ é™¤">âœ•</button>
                `;
                
                // ç‚¹å‡» Prompt é¡¹ï¼Œæ˜¾ç¤ºè¯¦æƒ…
                item.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸æ˜¾ç¤ºè¯¦æƒ…
                    if (e.target.classList.contains('favorite-item-delete')) {
                        return;
                    }
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶çº§
                    showPromptDetail(prompt);
                    // æ·»åŠ æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('#promptsList .favorite-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    closeSidebar();
                });
                
                // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const deleteBtn = item.querySelector('.favorite-item-delete');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ª Prompt å—ï¼Ÿ')) {
                        removePrompt(prompt.id);
                    }
                });
                
                promptsList.appendChild(item);
            });
        }
        
        /**
         * æ˜¾ç¤º Prompt è¯¦æƒ…
         */
        function showPromptDetail(prompt) {
            const promptDetailContent = document.getElementById('promptDetailContent');
            const promptDetailModalOverlay = document.getElementById('promptDetailModalOverlay');
            
            // æ„å»ºè¯¦æƒ…å†…å®¹
            const detailDisplay = document.createElement('div');
            detailDisplay.className = 'preference-display';
            
            if (prompt.topic) {
                const item1 = document.createElement('div');
                item1.className = 'preference-item';
                item1.innerHTML = `
                    <div class="preference-label">I want to learn:</div>
                    <div class="preference-value">${prompt.topic}</div>
                `;
                detailDisplay.appendChild(item1);
            }
            
            if (prompt.grade) {
                const item2 = document.createElement('div');
                item2.className = 'preference-item';
                item2.innerHTML = `
                    <div class="preference-label">Grade:</div>
                    <div class="preference-value">${prompt.grade}</div>
                `;
                detailDisplay.appendChild(item2);
            }
            
            if (prompt.difficulty) {
                const item3 = document.createElement('div');
                item3.className = 'preference-item';
                item3.innerHTML = `
                    <div class="preference-label">Difficulty:</div>
                    <div class="preference-value">${prompt.difficulty}</div>
                `;
                detailDisplay.appendChild(item3);
            }
            
            if (prompt.number) {
                const item4 = document.createElement('div');
                item4.className = 'preference-item';
                item4.innerHTML = `
                    <div class="preference-label">Number of Problems:</div>
                    <div class="preference-value">${prompt.number}</div>
                `;
                detailDisplay.appendChild(item4);
            }
            
            if (prompt.requirements) {
                const item5 = document.createElement('div');
                item5.className = 'preference-item';
                item5.innerHTML = `
                    <div class="preference-label">Additional Requirements:</div>
                    <div class="preference-value">${prompt.requirements}</div>
                `;
                detailDisplay.appendChild(item5);
            }
            
            if (prompt.selectedTags && prompt.selectedTags.length > 0) {
                const item6 = document.createElement('div');
                item6.className = 'preference-item';
                item6.innerHTML = `
                    <div class="preference-label">I want to involve:</div>
                    <div class="preference-value">${prompt.selectedTags.join(', ')}</div>
                `;
                detailDisplay.appendChild(item6);
            }
            
            promptDetailContent.innerHTML = '';
            promptDetailContent.appendChild(detailDisplay);
            
            // å­˜å‚¨å½“å‰è¦å¯¼å…¥çš„ Promptï¼ˆç”¨äº Import æŒ‰é’®ï¼‰
            promptDetailModalOverlay.dataset.currentPromptId = prompt.id;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            promptDetailModalOverlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * å¯¼å…¥ Prompt è®¾ç½®
         */
        function importPromptSettings() {
            const promptId = document.getElementById('promptDetailModalOverlay').dataset.currentPromptId;
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '[]');
            const prompt = savedPrompts.find(p => p.id === promptId);
            
            if (!prompt) {
                alert('Prompt è®¾ç½®æœªæ‰¾åˆ°');
                return;
            }
            
            // å¯¼å…¥è®¾ç½®åˆ°å„ä¸ªè¾“å…¥æ¡†
            if (prompt.topic) {
                document.getElementById('topic').value = prompt.topic;
            }
            
            if (prompt.grade) {
                document.getElementById('grade').value = prompt.grade;
            }
            
            if (prompt.difficulty) {
                document.getElementById('difficulty').value = prompt.difficulty;
            }
            
            if (prompt.number) {
                document.getElementById('number').value = prompt.number;
            }
            
            if (prompt.requirements) {
                document.getElementById('requirements').value = prompt.requirements;
            }
            
            // å¯¼å…¥æ ‡ç­¾
            if (prompt.selectedTags && prompt.selectedTags.length > 0) {
                const tagContainer = document.getElementById('tagContainer');
                tagContainer.innerHTML = '';
                
                prompt.selectedTags.forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.textContent = tag;
                    tagElement.onclick = () => {
                        tagElement.classList.toggle('selected');
                        saveTagsToLocalStorage();
                    };
                    tagContainer.appendChild(tagElement);
                });
                
                // ä¿å­˜æ ‡ç­¾åˆ° localStorage
                saveTagsToLocalStorage();
            }
            
            console.log('Prompt è®¾ç½®å·²å¯¼å…¥:', prompt);
            alert('Prompt è®¾ç½®å·²å¯¼å…¥ï¼');
            closePromptDetailModal();
        }
        
        /**
         * å…³é—­ Prompt è¯¦æƒ…æ¨¡æ€æ¡†
         */
        function closePromptDetailModal() {
            const promptDetailModalOverlay = document.getElementById('promptDetailModalOverlay');
            promptDetailModalOverlay.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        /**
         * åˆ é™¤ Prompt
         */
        function removePrompt(promptId) {
            const savedPrompts = JSON.parse(localStorage.getItem('savedPrompts') || '[]');
            const filtered = savedPrompts.filter(p => p.id !== promptId);
            localStorage.setItem('savedPrompts', JSON.stringify(filtered));
            loadPromptsList();
            
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¢«åˆ é™¤çš„ Promptï¼Œå…³é—­æ¨¡æ€æ¡†
            const currentPromptId = document.getElementById('promptDetailModalOverlay').dataset.currentPromptId;
            if (currentPromptId === promptId) {
                closePromptDetailModal();
            }
        }
        
        // Save Prompt æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('savePromptBtn').addEventListener('click', savePromptSettings);
        
        // Prompt è¯¦æƒ…æ¨¡æ€æ¡†äº‹ä»¶
        const promptDetailModalOverlay = document.getElementById('promptDetailModalOverlay');
        const promptDetailModalClose = document.getElementById('promptDetailModalClose');
        const promptDetailModalCancel = document.getElementById('promptDetailModalCancel');
        const promptDetailModalImport = document.getElementById('promptDetailModalImport');
        
        promptDetailModalClose.addEventListener('click', closePromptDetailModal);
        promptDetailModalCancel.addEventListener('click', closePromptDetailModal);
        promptDetailModalImport.addEventListener('click', importPromptSettings);
        promptDetailModalOverlay.addEventListener('click', function(e) {
            if (e.target === promptDetailModalOverlay) {
                closePromptDetailModal();
            }
        });

        // é¡µé¢åŠ è½½æ—¶åŠ è½½ç”¨æˆ·åå¥½å’ŒPromptåˆ—è¡¨ï¼ˆä¸å†å¼ºåˆ¶è·³è½¬ï¼‰
        window.onload = function() {
            loadUserPreferences();
            loadPromptsList(); // åŠ è½½ Prompt åˆ—è¡¨
        };

        // ============================================
        // ä¾§è¾¹æ èœå•åŠŸèƒ½
        // ============================================
        
        const menuToggleBtn = document.getElementById('menuToggleBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
        
        /**
         * æ‰“å¼€ä¾§è¾¹æ 
         */
        function openSidebar() {
            sidebar.classList.add('show');
            sidebarOverlay.classList.add('show');
            // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * å…³é—­ä¾§è¾¹æ 
         */
        function closeSidebar() {
            sidebar.classList.remove('show');
            sidebarOverlay.classList.remove('show');
            // æ¢å¤èƒŒæ™¯æ»šåŠ¨
            document.body.style.overflow = '';
        }
        
        /**
         * åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
         */
        function toggleSidebar() {
            if (sidebar.classList.contains('show')) {
                closeSidebar();
            } else {
                openSidebar();
            }
        }
        
        // èœå•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        menuToggleBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            toggleSidebar();
        });
        
        // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        sidebarCloseBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            closeSidebar();
        });
        
        // ç‚¹å‡»é®ç½©å±‚å…³é—­ä¾§è¾¹æ 
        sidebarOverlay.addEventListener('click', function() {
            closeSidebar();
        });
        
        // ============================================
        // æ¨¡æ€æ¡†åŠŸèƒ½
        // ============================================
        
        // è´¦æˆ·ä¿¡æ¯æ¨¡æ€æ¡†
        const accountModalOverlay = document.getElementById('accountModalOverlay');
        const accountModal = document.getElementById('accountModal');
        const accountModalClose = document.getElementById('accountModalClose');
        const accountModalCancel = document.getElementById('accountModalCancel');
        const accountModalSave = document.getElementById('accountModalSave');
        
        /**
         * æ‰“å¼€è´¦æˆ·ä¿¡æ¯æ¨¡æ€æ¡†
         */
        function openAccountModal() {
            // è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
            let user = null;
            if (typeof firebase !== 'undefined' && firebase.auth) {
                user = firebase.auth().currentUser;
            }
            
            // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            if (!user) {
                window.location.href = '/login';
                return;
            }
            
            // å·²ç™»å½•ç”¨æˆ·ï¼Œæ˜¾ç¤ºè´¦æˆ·ä¿¡æ¯
            // è®¾ç½®é‚®ç®±
            document.getElementById('accountEmail').value = user.email || '';
            
            // è®¾ç½®å¤´åƒåˆå§‹å­—æ¯
            const avatar = document.getElementById('accountAvatar');
            const email = user.email || '';
            const initials = email.substring(0, 2).toUpperCase();
            avatar.textContent = initials;
            
            // ä» localStorage è·å–æ˜¾ç¤ºåç§°å’Œç”¨æˆ·åï¼ˆå¦‚æœå·²ä¿å­˜ï¼‰
            const userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
            document.getElementById('accountDisplayName').value = userProfile.displayName || '';
            document.getElementById('accountUsername').value = userProfile.username || email.split('@')[0] || '';
            
            accountModalOverlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * å…³é—­è´¦æˆ·ä¿¡æ¯æ¨¡æ€æ¡†
         */
        function closeAccountModal() {
            accountModalOverlay.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        /**
         * ä¿å­˜è´¦æˆ·ä¿¡æ¯
         */
        function saveAccountInfo() {
            const displayName = document.getElementById('accountDisplayName').value;
            const username = document.getElementById('accountUsername').value;
            
            // ä¿å­˜åˆ° localStorage
            const userProfile = {
                displayName: displayName,
                username: username
            };
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            
            console.log('è´¦æˆ·ä¿¡æ¯å·²ä¿å­˜:', userProfile);
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æç¤ºæ¶ˆæ¯
            alert('è´¦æˆ·ä¿¡æ¯å·²ä¿å­˜ï¼');
            
            closeAccountModal();
        }
        
        /**
         * ç”¨æˆ·ç™»å‡º
         */
        async function logoutUser() {
            try {
                if (typeof firebase !== 'undefined' && firebase.auth) {
                    await firebase.auth().signOut();
                    console.log('ç”¨æˆ·å·²ç™»å‡º');
                    
                    // ç™»å‡ºåå…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°è·³è½¬åˆ°ä¸»é¡µï¼ˆæœªç™»å½•çŠ¶æ€ï¼‰
                    closeAccountModal();
                    window.location.href = '/';
                } else {
                    console.error('Firebase æœªæ­£ç¡®åˆå§‹åŒ–');
                    alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                }
            } catch (error) {
                console.error('ç™»å‡ºé”™è¯¯:', error);
                alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
            }
        }
        
        /**
         * æ‰“å¼€å…´è¶£åå¥½æ¨¡æ€æ¡†
         */
        function openInterestModal() {
            // ä» localStorage è¯»å–ç”¨æˆ·åå¥½ï¼ˆPersonalizationé¡µé¢å­˜å‚¨çš„å†…å®¹ï¼‰
            const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            
            // æ¸…ç©ºå†…å®¹åŒºåŸŸ
            const interestContent = document.getElementById('interestContent');
            interestContent.innerHTML = '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰åå¥½æ•°æ®
            if (Object.keys(preferences).length === 0 || (!preferences.question1 && !preferences.question2 && !preferences.question3)) {
                interestContent.innerHTML = '<div class="preference-empty">No interest preferences set. Please go to Personalization page to set your preferences.</div>';
            } else {
                // æ˜¾ç¤ºå…´è¶£åå¥½
                const interestDisplay = document.createElement('div');
                interestDisplay.className = 'preference-display';
                
                // æ˜¾ç¤ºä¸‰ä¸ªé—®é¢˜çš„ç­”æ¡ˆï¼ˆæ¥è‡ªPersonalizationé¡µé¢ï¼‰
                if (preferences.question1) {
                    const item1 = document.createElement('div');
                    item1.className = 'preference-item';
                    item1.innerHTML = `
                        <div class="preference-label">What are your hobbies?</div>
                        <div class="preference-value">${preferences.question1}</div>
                    `;
                    interestDisplay.appendChild(item1);
                }
                
                if (preferences.question2) {
                    const item2 = document.createElement('div');
                    item2.className = 'preference-item';
                    item2.innerHTML = `
                        <div class="preference-label">What topics are you interested in?</div>
                        <div class="preference-value">${preferences.question2}</div>
                    `;
                    interestDisplay.appendChild(item2);
                }
                
                if (preferences.question3) {
                    const item3 = document.createElement('div');
                    item3.className = 'preference-item';
                    item3.innerHTML = `
                        <div class="preference-label">What types of books and videos do you usually enjoy?</div>
                        <div class="preference-value">${preferences.question3}</div>
                    `;
                    interestDisplay.appendChild(item3);
                }
                
                interestContent.appendChild(interestDisplay);
            }
            
            const interestModalOverlay = document.getElementById('interestModalOverlay');
            interestModalOverlay.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        /**
         * è·³è½¬åˆ° Personalization é¡µé¢
         */
        function goToPersonalization() {
            window.location.href = '/personalization';
        }
        
        /**
         * å…³é—­å…´è¶£åå¥½æ¨¡æ€æ¡†
         */
        function closeInterestModal() {
            const interestModalOverlay = document.getElementById('interestModalOverlay');
            interestModalOverlay.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // è´¦æˆ·ä¿¡æ¯æ¨¡æ€æ¡†äº‹ä»¶
        const accountModalLogout = document.getElementById('accountModalLogout');
        
        accountModalClose.addEventListener('click', closeAccountModal);
        accountModalLogout.addEventListener('click', logoutUser);
        accountModalSave.addEventListener('click', saveAccountInfo);
        accountModalOverlay.addEventListener('click', function(e) {
            if (e.target === accountModalOverlay) {
                closeAccountModal();
            }
        });
        
        // å…´è¶£åå¥½æ¨¡æ€æ¡†äº‹ä»¶
        const interestModalOverlay = document.getElementById('interestModalOverlay');
        const interestModalClose = document.getElementById('interestModalClose');
        const interestModalCancel = document.getElementById('interestModalCancel');
        const interestModalGoToSettings = document.getElementById('interestModalGoToSettings');
        
        interestModalClose.addEventListener('click', closeInterestModal);
        interestModalCancel.addEventListener('click', closeInterestModal);
        interestModalGoToSettings.addEventListener('click', function() {
            closeInterestModal();
            goToPersonalization();
        });
        interestModalOverlay.addEventListener('click', function(e) {
            if (e.target === interestModalOverlay) {
                closeInterestModal();
            }
        });
        
        // ESC é”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (accountModalOverlay.classList.contains('show')) {
                    closeAccountModal();
                }
                if (interestModalOverlay.classList.contains('show')) {
                    closeInterestModal();
                }
                if (promptDetailModalOverlay.classList.contains('show')) {
                    closePromptDetailModal();
                }
            }
        });
        
        // èœå•é¡¹ç‚¹å‡»äº‹ä»¶
        const menuItemAccount = document.getElementById('menuItemAccount');
        const menuItemInterest = document.getElementById('menuItemInterest');
        const menuItemPrompts = document.getElementById('menuItemPrompts');
        const menuItemQuestions = document.getElementById('menuItemQuestions');
        
        menuItemAccount.addEventListener('click', function() {
            closeSidebar();
            setTimeout(() => {
                openAccountModal();
            }, 200);
        });
        
        menuItemInterest.addEventListener('click', function() {
            closeSidebar();
            setTimeout(() => {
                openInterestModal();
            }, 200);
        });
        
        // My Prompts å±•å¼€/æ”¶èµ·åŠŸèƒ½
        menuItemPrompts.addEventListener('click', function() {
            const promptsListContent = document.getElementById('promptsListContent');
            const arrow = this.querySelector('.sidebar-menu-item-arrow');
            const isExpanded = promptsListContent.classList.contains('expanded');
            
            if (isExpanded) {
                promptsListContent.classList.remove('expanded');
                arrow.textContent = 'â–¶';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                promptsListContent.classList.add('expanded');
                arrow.textContent = 'â–¼';
                arrow.style.transform = 'rotate(0deg)';
            }
        });
        
        // My Questions å±•å¼€/æ”¶èµ·åŠŸèƒ½
        menuItemQuestions.addEventListener('click', function() {
            const questionsListContent = document.getElementById('questionsListContent');
            const arrow = this.querySelector('.sidebar-menu-item-arrow');
            const isExpanded = questionsListContent.classList.contains('expanded');
            
            if (isExpanded) {
                questionsListContent.classList.remove('expanded');
                arrow.textContent = 'â–¶';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                questionsListContent.classList.add('expanded');
                arrow.textContent = 'â–¼';
                arrow.style.transform = 'rotate(0deg)';
            }
        });
        
        // ============================================
        // æ”¶è—åŠŸèƒ½
        // ============================================
        
        const favoritesList = document.getElementById('favoritesList');
        
        /**
         * ä¿å­˜é—®é¢˜åˆ°æ”¶è—
         * @param {Object} data - é—®é¢˜æ•°æ® {problem, hints, solution, answer}
         * @param {Boolean} wasFavorited - æ˜¯å¦å·²ç»æ”¶è—ï¼ˆç”¨äºåˆ‡æ¢çŠ¶æ€ï¼‰
         */
        function saveToFavorites(data, wasFavorited = false) {
            const favorites = JSON.parse(localStorage.getItem('favoriteQuestions') || '[]');
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé€šè¿‡é—®é¢˜å‰200ä¸ªå­—ç¬¦åˆ¤æ–­ï¼‰
            const problemHash = data.problem.substring(0, 200).trim();
            const existingIndex = favorites.findIndex(fav => {
                const favProblemHash = fav.problem.substring(0, 200).trim();
                return favProblemHash === problemHash;
            });
            
            if (wasFavorited || existingIndex !== -1) {
                // å¦‚æœå·²å­˜åœ¨ï¼Œç§»é™¤æ”¶è—
                if (existingIndex !== -1) {
                    favorites.splice(existingIndex, 1);
                }
                console.log('å·²å–æ¶ˆæ”¶è—');
            } else {
                // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ æ”¶è—
                const favoriteItem = {
                    id: Date.now().toString(), // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
                    problem: data.problem,
                    hints: data.hints || '',
                    solution: data.solution || '',
                    answer: data.answer || '',
                    title: getProblemTitle(data.problem), // æå–é—®é¢˜æ ‡é¢˜
                    createdAt: new Date().toISOString()
                };
                favorites.unshift(favoriteItem); // æ·»åŠ åˆ°å¼€å¤´
                console.log('å·²æ·»åŠ åˆ°æ”¶è—');
            }
            
            // ä¿å­˜åˆ° localStorage
            localStorage.setItem('favoriteQuestions', JSON.stringify(favorites));
            
            // æ›´æ–°æ”¶è—åˆ—è¡¨
            loadFavoritesList();
        }
        
        /**
         * ä»é—®é¢˜æ–‡æœ¬ä¸­æå–æ ‡é¢˜ï¼ˆå‰å‡ ä¸ªå•è¯ï¼‰
         */
        function getProblemTitle(problemText) {
            // ç§»é™¤ Markdown æ ¼å¼
            const text = problemText.replace(/[#*`_\[\]()]/g, '').trim();
            // è·å–å‰30ä¸ªå­—ç¬¦
            const title = text.substring(0, 30);
            // å¦‚æœè¶…è¿‡30ä¸ªå­—ç¬¦ï¼Œæ·»åŠ çœç•¥å·
            return text.length > 30 ? title + '...' : title;
        }
        
        /**
         * åŠ è½½æ”¶è—åˆ—è¡¨
         */
        function loadFavoritesList() {
            const favorites = JSON.parse(localStorage.getItem('favoriteQuestions') || '[]');
            
            // æ¸…ç©ºåˆ—è¡¨
            favoritesList.innerHTML = '';
            
            if (favorites.length === 0) {
                favoritesList.innerHTML = '<div class="favorites-empty">No favorites</div>';
                return;
            }
            
            // æ˜¾ç¤ºæ”¶è—åˆ—è¡¨
            favorites.forEach(favorite => {
                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.dataset.favoriteId = favorite.id;
                
                const date = new Date(favorite.createdAt);
                const dateStr = date.toLocaleDateString('zh-CN', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                item.innerHTML = `
                    <div class="favorite-item-content">
                        <div class="favorite-item-title">${favorite.title}</div>
                        <div class="favorite-item-date">${dateStr}</div>
                    </div>
                    <button class="favorite-item-delete" data-favorite-id="${favorite.id}" title="åˆ é™¤">âœ•</button>
                `;
                
                // ç‚¹å‡»æ”¶è—é¡¹ï¼ŒåŠ è½½é—®é¢˜
                item.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸åŠ è½½é—®é¢˜
                    if (e.target.classList.contains('favorite-item-delete')) {
                        return;
                    }
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶çº§
                    loadFavoriteQuestion(favorite);
                    // æ·»åŠ æ¿€æ´»çŠ¶æ€
                    document.querySelectorAll('.favorite-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    closeSidebar();
                });
                
                // åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const deleteBtn = item.querySelector('.favorite-item-delete');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ”¶è—å—ï¼Ÿ')) {
                        removeFavorite(favorite.id);
                    }
                });
                
                favoritesList.appendChild(item);
            });
        }
        
        /**
         * åŠ è½½æ”¶è—çš„é—®é¢˜
         */
        function loadFavoriteQuestion(favorite) {
            const result = document.getElementById('result');
            const hintSection = document.getElementById('hintSection');
            const solutionSection = document.getElementById('solutionSection');
            const hintBtn = document.getElementById('hintBtn');
            const solutionBtn = document.getElementById('solutionBtn');
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            result.innerHTML = '';
            result.className = ''; // é‡ç½® result çš„ç±»
            hintSection.innerHTML = '';
            solutionSection.innerHTML = '';
            
            // éšè— Hints å’Œ Solution åŒºåŸŸ
            document.getElementById('hintExpandableSection').classList.remove('has-content');
            document.getElementById('solutionExpandableSection').classList.remove('has-content');
            
            // æ˜¾ç¤ºé—®é¢˜
            try {
                if (typeof marked !== 'undefined') {
                    // ç›´æ¥ä½¿ç”¨ resultï¼Œåº”ç”¨ section-content æ ·å¼
                    result.className = 'section-content show';
                    result.innerHTML = marked.parse(favorite.problem);
                    
                    // æ·»åŠ æ”¶è—æŒ‰é’®åˆ°å®¹å™¨ä¸­
                    const favoriteBtnContainer = document.getElementById('favoriteBtnContainer');
                    favoriteBtnContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
                    
                    const favoriteBtn = document.createElement('button');
                    favoriteBtn.className = 'favorite-btn favorited';
                    favoriteBtn.id = 'favoriteBtn';
                    favoriteBtn.innerHTML = '<span class="favorite-btn-icon">â™¥</span> <span>Favorited</span>';
                    favoriteBtn.addEventListener('click', function() {
                        // é‡æ–°ä¿å­˜ä»¥åˆ‡æ¢æ”¶è—çŠ¶æ€
                        saveToFavorites({
                            problem: favorite.problem,
                            hints: favorite.hints,
                            solution: favorite.solution,
                            answer: favorite.answer
                        });
                        this.classList.toggle('favorited');
                        if (this.classList.contains('favorited')) {
                            this.innerHTML = '<span class="favorite-btn-icon">â™¥</span> <span>Favorited</span>';
                        } else {
                            this.innerHTML = '<span class="favorite-btn-icon">â™¡</span> <span>Add to Favorites</span>';
                        }
                        loadFavoritesList();
                    });
                    favoriteBtnContainer.appendChild(favoriteBtn);
                } else {
                    result.textContent = favorite.problem;
                }
                
                // æ˜¾ç¤ºæç¤º
                const hintExpandableSection = document.getElementById('hintExpandableSection');
                if (favorite.hints) {
                    hintSection.innerHTML = marked.parse(favorite.hints);
                    hintExpandableSection.classList.add('has-content'); // æ˜¾ç¤º Hints åŒºåŸŸ
                } else {
                    hintExpandableSection.classList.remove('has-content'); // éšè— Hints åŒºåŸŸ
                }
                
                // æ˜¾ç¤ºè§£ç­”
                const solutionExpandableSection = document.getElementById('solutionExpandableSection');
                if (favorite.solution || favorite.answer) {
                    let solutionContent = '';
                    if (favorite.solution) {
                        solutionContent += '### Step-by-Step Solution\n' + favorite.solution;
                    }
                    if (favorite.answer) {
                        solutionContent += '\n\n### Final Answer\n' + favorite.answer;
                    }
                    solutionSection.innerHTML = marked.parse(solutionContent);
                    solutionExpandableSection.classList.add('has-content'); // æ˜¾ç¤º Solution åŒºåŸŸ
                } else {
                    solutionExpandableSection.classList.remove('has-content'); // éšè— Solution åŒºåŸŸ
                }
                
                // è®¾ç½®æŒ‰é’®äº‹ä»¶
                const hintTitleText = hintBtn.querySelector('.section-title-text');
                const solutionTitleText = solutionBtn.querySelector('.section-title-text');
                
                hintBtn.onclick = function() {
                    hintSection.classList.toggle('show');
                    this.classList.toggle('active');
                    hintTitleText.textContent = hintSection.classList.contains('show') ? 'Hide Hints' : 'Show Hints';
                };
                
                solutionBtn.onclick = function() {
                    solutionSection.classList.toggle('show');
                    this.classList.toggle('active');
                    solutionTitleText.textContent = solutionSection.classList.contains('show') ? 'Hide Solution' : 'Show Solution';
                };
                
                // è‡ªåŠ¨æ˜¾ç¤ºæç¤ºå’Œè§£ç­”
                hintSection.classList.add('show');
                solutionSection.classList.add('show');
                hintBtn.classList.add('active');
                solutionBtn.classList.add('active');
                hintTitleText.textContent = 'Hide Hints';
                solutionTitleText.textContent = 'Hide Solution';
                
            } catch (error) {
                console.error('åŠ è½½æ”¶è—é—®é¢˜é”™è¯¯:', error);
                result.className = 'section-content show';
                result.textContent = 'åŠ è½½é—®é¢˜å¤±è´¥';
                // éšè— Hints å’Œ Solution åŒºåŸŸ
                document.getElementById('hintExpandableSection').classList.remove('has-content');
                document.getElementById('solutionExpandableSection').classList.remove('has-content');
            }
        }
        
        /**
         * åˆ é™¤æ”¶è—
         */
        function removeFavorite(favoriteId) {
            const favorites = JSON.parse(localStorage.getItem('favoriteQuestions') || '[]');
            const filtered = favorites.filter(fav => fav.id !== favoriteId);
            localStorage.setItem('favoriteQuestions', JSON.stringify(filtered));
            loadFavoritesList();
            
            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯è¢«åˆ é™¤çš„é—®é¢˜ï¼Œæ¸…ç©ºæ˜¾ç¤º
            const currentFavoriteId = document.querySelector('.favorite-item.active')?.dataset.favoriteId;
            if (currentFavoriteId === favoriteId) {
                document.getElementById('result').innerHTML = '';
                document.getElementById('hintSection').innerHTML = '';
                document.getElementById('solutionSection').innerHTML = '';
                document.getElementById('favoriteBtnContainer').innerHTML = '';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ”¶è—åˆ—è¡¨
        window.addEventListener('load', function() {
            loadFavoritesList();
            loadPromptsList(); // åŠ è½½ Prompt åˆ—è¡¨
        });
        
        // ESC é”®å…³é—­ä¾§è¾¹æ 
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && sidebar.classList.contains('show')) {
                closeSidebar();
            }
        });
    </script>
</body>
</html>
